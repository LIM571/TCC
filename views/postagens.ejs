<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

<div class="flex p-6">
    <div id="forumContainer" class="bg-red-700 p-6 rounded-lg shadow-lg w-1/4 mr-6 h-auto transition-all duration-300">
        <a href="forum" class="text-white text-3xl mb-8">Fórum</a>
        <div class="flex justify-between mt-3 mb-4">
            <a href="#" id="addTopico" class="text-white underline cursor-pointer" onclick="toggleForm()">Adicionar Tópico</a>
        </div>

        <div id="formContainer" class="hidden mb-4">
            <form onsubmit="return addTopico(event)" class="bg-gray-800 p-4 rounded-lg shadow-md">
                <div class="mb-4">
                    <label for="titulo" class="block text-white mb-2">Título:</label>
                    <input type="text" id="titulo" name="titulo" required class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500">
                </div>
                <div class="mb-4">
                    <label for="descricao" class="block text-white mb-2">Descrição:</label>
                    <textarea id="descricao" name="descricao" required class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500"></textarea>
                </div>
                <button type="submit" class="bg-red-800 text-white px-4 py-2 rounded-md hover:bg-red-900 focus:outline-none focus:ring-2 focus:ring-red-500">
                    Adicionar Tópico
                </button>
            </form>
        </div>

        <ul id="topicosList" class="space-y-2">
            <% topicos.forEach(topico => { %>
                <li class="bg-gray-800 p-4 rounded-lg shadow-lg">
                    <h2 class="text-white text-xl font-bold"><%= topico.titulo %></h2>
                    <a href="/forum/<%= topico.id %>" class="text-blue-400">Ver Discussão</a>
                </li>
            <% }) %>
        </ul>
    </div>

    <div class="flex-grow p-6">
        <div id="postagens-container" class="flex flex-col space-y-4 p-4 rounded-lg shadow-lg">
            <% for (let j = 0; j < postagens.length; j++) { %>
                <% const userPost = usuarios.find(user => user.id === postagens[j].usuario_id); %>
                <% if (userPost) { %>
                    <div class="postagem flex flex-col p-6 bg-white w-96 lg mx-auto text-center shadow-md rounded-lg h-5/6"> <!-- Largura diminuída -->
                        <div class="flex items-center mb-2">
                            <img class="w-12 h-12 rounded-full mr-2" src="/imagens/<%= userPost.img %>" alt="User Avatar">
                            <h2 class="text-lg font-bold text-black"><%= userPost.nome %></h2>
                        </div>
                        <img class="w-full h-48 object-cover rounded-md mb-2" src="/imagens/<%= postagens[j].midia %>" alt="User Image">
                        <p class="text-black text-base mb-2">
                            <%= postagens[j].descricao %>
                        </p>

                        <div class="flex justify-around items-center">
                            <form action="resposta/cadastro" method="POST" class="flex items-center space-x-2">
                                <input type="hidden" name="postagem_id" value="<%= postagens[j].id_post %>">
                                <button type="submit" class="text-black hover:text-red-500 flex items-center space-x-1">
                                    <i class="fas fa-comment-alt fa-lg"></i>
                                    <span class="text-sm">Responder</span>
                                </button>
                            </form>

                            <% if (userPost.categoria === usuarioAtual.categoria && userPost.lvl_profissional === usuarioAtual.lvl_profissional) { %>
                                <a href="#" class="text-black hover:text-red-500 flex items-center space-x-1">
                                    <i class="fas fa-fist-raised fa-lg"></i>
                                    <span class="text-sm">Desafiar</span>
                                </a>
                            <% } %>
                        </div>

                        <div class="mt-2">
                            <button onclick="toggleComentarios(<%= postagens[j].id_post %>)" class="bg-red-700 hover:bg-red-800 text-white font-bold py-1 px-2 rounded-full mb-2">
                                Mostrar Comentários
                            </button>

                            <div id="comentarios-<%= postagens[j].id_post %>" class="hidden">
                                <h3 class="text-lg font-bold mb-2">Respostas</h3>
                                <% let count = 0; %>
                                <% for (let x = 0; x < resposta.length; x++) { 
                                    const userResposta = usuarios.find(user => user.id === resposta[x].usuario_id);
                                    if (postagens[j].id_post == resposta[x].postagem_id) { %>
                                        <% if (count < 5) { %>
                                            <div class="bg-gray-700 p-2 rounded-lg mb-2 shadow-sm flex items-center">
                                                <img class="w-8 h-8 rounded-full mr-2" src="/imagens/<%= userResposta.img %>" alt="User Avatar">
                                                <div>
                                                    <p class="font-bold text-gray-300"><%= userResposta.nome %></p>
                                                    <p class="text-gray-200 text-sm"><%= resposta[x].conteudo %></p>
                                                </div>
                                            </div>
                                            <% count++; %>
                                        <% } %>
                                    <% } %>
                                <% } %>

                                <% if (resposta.length > 5) { %>
                                    <button onclick="loadMore(<%= postagens[j].id_post %>)" class="bg-red-700 hover:bg-red-800 text-white font-bold py-1 px-2 rounded-full">
                                        Ver Mais
                                    </button>
                                <% } %>
                            </div>
                        </div>
                    </div>
                <% } %>
            <% } %>
        </div>
    </div>
</div>

<script>
    function toggleComentarios(postId) {
        const comentariosDiv = document.getElementById(`comentarios-${postId}`);
        comentariosDiv.classList.toggle('hidden');
    }

    function toggleForm() {
        const formContainer = document.getElementById('formContainer');
        formContainer.classList.toggle('hidden');
    }

    function addTopico(event) {
        event.preventDefault(); // Impede o envio padrão do formulário

        const titulo = document.getElementById('titulo').value;
        const descricao = document.getElementById('descricao').value;

        // Adiciona o novo tópico na lista
        const topicosList = document.getElementById('topicosList');
        const newTopic = document.createElement('li');
        newTopic.className = "bg-gray-800 p-4 rounded-lg shadow-lg";
        newTopic.innerHTML = `<h2 class="text-white text-xl font-bold">${titulo}</h2>
                              <a href="#" class="text-blue-400">Ver Discussão</a>`;
        topicosList.prepend(newTopic);

        // Aumenta a altura do contêiner do fórum
        const forumContainer = document.getElementById('forumContainer');
        forumContainer.classList.remove('h-96');
        forumContainer.classList.add('h-auto');

        // Limpa os campos do formulário
        document.getElementById('titulo').value = '';
        document.getElementById('descricao').value = '';
        toggleForm(); // Esconde o formulário após adicionar
    }

    function loadMorePosts() {
        const postagens = document.querySelectorAll('.postagem');
        postagens.forEach(postagem => {
            postagem.classList.remove('hidden'); // Remove a classe 'hidden' de todas as postagens
        });
        document.getElementById('btnVerMais').classList.add('hidden'); // Oculta o botão "Ver Mais"
    }
</script>
